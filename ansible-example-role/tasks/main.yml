# This is my own personal way of doing this. Assets go on a folder
# in my NAS. You can just bind minio to whatever folder you want
- name: Container data folder for MinIO
  ansible.builtin.include_role:
    role: docker/container-data
  vars:
    dir_name: "stoat-assets"

- name: Set stoat data directory
  ansible.builtin.set_fact:
    stoat_data_dir: /home/docker/stoat

- name: Create MinIO directory on container data
  ansible.builtin.file:
    path: "{{ container_data_base_path }}/stoat-assets/minio"
    state: directory
    mode: '0777'

- name: Create directories
  ansible.builtin.file:
    path: "{{ stoat_data_dir }}/{{ item }}"
    state: directory
    mode: '0777'
  loop:
    - db
    - configs
    - rabbit
    - caddy-data
    - caddy-config
    - redis

- name: Template configuration files
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "{{ stoat_data_dir }}/configs/{{ item }}"
    mode: '0644'
  loop:
    - Revolt.toml
    - Caddyfile
    - env.web

- name: Create Docker network
  community.docker.docker_network:
    name: "{{ docker_network }}"
    state: present

# ──────────────────────────────────────────────
# MongoDB
# ──────────────────────────────────────────────
- name: Start MongoDB
  community.docker.docker_container:
    name: stoat-database
    image: docker.io/mongo
    state: started
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    volumes:
      - "{{ stoat_data_dir }}/db:/data/db"
    healthcheck:
      test: ["CMD", "bash", "-c", "echo 'db.runCommand(\"ping\").ok' | mongosh localhost:27017/test --quiet"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s

# ──────────────────────────────────────────────
# Redis (KeyDB)
# ──────────────────────────────────────────────
- name: Start Redis (KeyDB)
  community.docker.docker_container:
    name: stoat-redis
    image: docker.io/eqalpha/keydb
    state: started
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    volumes:
      - "{{ stoat_data_dir }}/redis:/data"

# ──────────────────────────────────────────────
# RabbitMQ
# ──────────────────────────────────────────────
- name: Start RabbitMQ
  community.docker.docker_container:
    name: stoat-rabbit
    image: docker.io/rabbitmq:4
    state: started
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    env:
      RABBITMQ_DEFAULT_USER: "{{ rabbitmq_user }}"
      RABBITMQ_DEFAULT_PASS: "{{ rabbitmq_pass }}"
    volumes:
      - "{{ stoat_data_dir }}/rabbit:/var/lib/rabbitmq"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 20s

# ──────────────────────────────────────────────
# MinIO
# ──────────────────────────────────────────────
- name: Start MinIO
  community.docker.docker_container:
    name: stoat-minio
    image: docker.io/minio/minio
    state: started
    restart_policy: always
    command: server /data
    networks:
      - name: "{{ docker_network }}"
        aliases:
          - minio
          - revolt-uploads.minio
          - attachments.minio
          - avatars.minio
          - backgrounds.minio
          - icons.minio
          - banners.minio
          - emojis.minio
    env:
      MINIO_ROOT_USER: "{{ minio_root_user }}"
      MINIO_ROOT_PASSWORD: "{{ minio_root_password }}"
      MINIO_DOMAIN: minio
    volumes:
      - "{{ container_data_base_path }}/stoat-assets/minio:/data"

# ──────────────────────────────────────────────
# Create MinIO buckets
# ──────────────────────────────────────────────
- name: Create MinIO buckets
  community.docker.docker_container:
    name: stoat-createbuckets
    image: docker.io/minio/mc
    state: started
    detach: false
    cleanup: true
    networks:
      - name: "{{ docker_network }}"
    entrypoint:
      - /bin/sh
      - -c
      - |
        while ! /usr/bin/mc ready minio; do
          /usr/bin/mc alias set minio http://stoat-minio:9000 {{ minio_root_user }} {{ minio_root_password }};
          echo 'Waiting minio...' && sleep 1;
        done;
        /usr/bin/mc mb minio/revolt-uploads;
        exit 0;
# ──────────────────────────────────────────────
# LiveKit (for voice and video)
# ──────────────────────────────────────────────
- name: Start LiveKit (Voice and Video)
  community.docker.docker_container:
    name: stoat-livekit-server
    image: livekit/livekit-server:v1.9.0
    state: started
    command:
      - --disable-strict-config
    env:
      # Generate LiveKit keys with: docker run --rm livekit/generate --local
      LIVEKIT_CONFIG: |
        keys:
          {{ livekit_api_key }}: {{ livekit_api_secret }}
        log_level: info
        port: 7880
        redis:
          address: stoat-redis:6379
        rtc:
          port_range_end: 50100
          port_range_start: 50000
          tcp_port: 7881
          use_external_ip: false
        turn:
          enabled: false
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    ports:
      - "7881:7881/tcp"
      - "50000-50100:50000-50100/udp"

# ──────────────────────────────────────────────
# Caddy
# ──────────────────────────────────────────────
- name: Start Caddy
  community.docker.docker_container:
    name: stoat-caddy
    image: docker.io/caddy
    state: started
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    ports:
      - "{{ stoat_external_port }}:80"
    volumes:
      - "{{ stoat_data_dir }}/configs/Caddyfile:/etc/caddy/Caddyfile"
      - "{{ stoat_data_dir }}/caddy-data:/data"
      - "{{ stoat_data_dir }}/caddy-config:/config"

# ──────────────────────────────────────────────
# API server
# ──────────────────────────────────────────────
- name: Start API server
  community.docker.docker_container:
    name: stoat-api
    image: ghcr.io/stoatchat/api:v0.11.0
    state: started
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    volumes:
      - "{{ stoat_data_dir }}/configs/Revolt.toml:/Revolt.toml:ro"

# ──────────────────────────────────────────────
# Events service (Bonfire)
# ──────────────────────────────────────────────
- name: Start Events service
  community.docker.docker_container:
    name: stoat-events
    image: ghcr.io/stoatchat/events:v0.11.0
    state: started
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    volumes:
      - "{{ stoat_data_dir }}/configs/Revolt.toml:/Revolt.toml:ro"

# ──────────────────────────────────────────────
# Web App
# ──────────────────────────────────────────────
- name: Start Web App (new client)
  community.docker.docker_container:
    name: stoat-web
    image: baptisterajaut/stoatchat-web:dev
    state: started
    recreate: true
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    env:
      REVOLT_PUBLIC_URL: "https://{{ stoat_domain }}/api"
      VITE_WS_URL: "wss://{{ stoat_domain }}/ws"
      VITE_MEDIA_URL: "https://{{ stoat_domain }}/autumn"
      VITE_PROXY_URL: "https://{{ stoat_domain }}/january"
# - name: Start Web App
#   community.docker.docker_container:
#     name: stoat-web
#     image: baptisterajaut/stoatchat-web:dev
#     state: started
#     recreate: true
#     restart_policy: always
#     networks:
#       - name: "{{ docker_network }}"
#     env_file: "{{ stoat_data_dir }}/configs/env.web"

# ──────────────────────────────────────────────
# Autumn (File server)
# ──────────────────────────────────────────────
- name: Start Autumn (file server)
  community.docker.docker_container:
    name: stoat-autumn
    image: ghcr.io/stoatchat/file-server:v0.11.0
    state: started
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    volumes:
      - "{{ stoat_data_dir }}/configs/Revolt.toml:/Revolt.toml:ro"

# ──────────────────────────────────────────────
# January (Metadata & image proxy)
# ──────────────────────────────────────────────
- name: Start January (metadata proxy)
  community.docker.docker_container:
    name: stoat-january
    image: ghcr.io/stoatchat/proxy:v0.11.0
    state: started
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    volumes:
      - "{{ stoat_data_dir }}/configs/Revolt.toml:/Revolt.toml:ro"

# ──────────────────────────────────────────────
# Gifbox (Tenor proxy)
# ──────────────────────────────────────────────
- name: Start Gifbox (Tenor proxy)
  community.docker.docker_container:
    name: stoat-gifbox
    image: ghcr.io/stoatchat/gifbox:v0.11.0
    state: started
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    volumes:
      - "{{ stoat_data_dir }}/configs/Revolt.toml:/Revolt.toml:ro"

# ──────────────────────────────────────────────
# Crond (Task daemon)
# ──────────────────────────────────────────────
- name: Start Crond (task daemon)
  community.docker.docker_container:
    name: stoat-crond
    image: ghcr.io/stoatchat/crond:v0.11.0
    state: started
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    volumes:
      - "{{ stoat_data_dir }}/configs/Revolt.toml:/Revolt.toml:ro"

# ──────────────────────────────────────────────
# Pushd (Push notification daemon)
# ──────────────────────────────────────────────
- name: Start Pushd (push notifications)
  community.docker.docker_container:
    name: stoat-pushd
    image: ghcr.io/stoatchat/pushd:v0.11.0
    state: started
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    volumes:
      - "{{ stoat_data_dir }}/configs/Revolt.toml:/Revolt.toml:ro"

# ──────────────────────────────────────────────
# Voice Ingress
# ──────────────────────────────────────────────
- name: Start Voice Ingress
  community.docker.docker_container:
    name: stoat-voice-ingress
    image: ghcr.io/stoatchat/voice-ingress:v0.11.0
    state: started
    restart_policy: always
    networks:
      - name: "{{ docker_network }}"
    volumes:
      - "{{ stoat_data_dir }}/configs/Revolt.toml:/Revolt.toml:ro"